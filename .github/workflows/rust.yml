name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:

    - name: Install CUDA
      run: |
        wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.1-1_all.deb
        sudo dpkg -i cuda-keyring_1.1-1_all.deb
        sudo apt-get update
        sudo apt-get -y install cuda libcudnn8 libcudnn8-dev
        echo "/usr/local/cuda/bin" >> $GITHUB_PATH
        
    - name: Install Torch
      run: |
        curl -L https://download.pytorch.org/libtorch/nightly/cu118/libtorch-shared-with-deps-latest.zip > libtorch-shared-with-deps-latest.zip && unzip libtorch-shared-with-deps-latest.zip
        cp -a libtorch/bin/. /usr/local/bin/
        cp -a libtorch/include/. /usr/share/include/
        cp -a libtorch/lib/. /usr/lib/lib/
        cp -a libtorch/share/. /usr/share/share/
        
    - name: Install TA-Lib
      run: |
        curl -L  http://downloads.sourceforge.net/project/ta-lib/0.4.0/ta-lib-0.4.0-src.tar.gz > ta-lib-0.4.0-src.tar.gz && tar -xzvf ta-lib-0.4.0-src.tar.gz
        cd ta-lib && ./configure --prefix=/usr
        cd ta-lib && make
        cd ta-lib && sudo make install
        
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose
